---
title: "Lending Club Data Cleaning"
author: "Evan Woods"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width = 6)
knitr::opts_chunk$set(fig.asp = 0.618)
knitr::opts_chunk$set(out.width = "70%")
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(
  comment = ""
)
```

```{r message=FALSE, include=FALSE}
if(!require("MASS")) install.packages("MASS")
if(!require("ISLR2")) install.packages("ISLR2")
if(!require("tidyverse")) install.packages("tidyverse")
if(!require("HH")) install.packages("HH") # VIF
if(!require("e1071")) install.packages("e1071") # naiveBayes
if(!require("class")) install.packages("class") # knn
if(!require("formulaic")) install.packages("formulaic")
if(!require("caTools")) install.packages("caTools")
if(!require("caret")) install.packages("caret")
if(!require("boot")) install.packages("boot")
if(!require("leaps")) install.packages("leaps") # regsubsets
if(!require("glmnet")) install.packages("glmnet") # Ridge and Lasso Regression
if(!require("pls")) install.packages("pls") # Partial Least Squares & Principal Component Regression
if(!require("splines")) install.packages("splines")
if(!require("gam")) install.packages("gam")
if(!require("akima")) install.packages("akima")
if(!require("tree")) install.packages("tree") # Classification and Regression Trees
if(!require("randomForest")) install.packages("randomForest")
if(!require("gbm")) install.packages("gbm") # Boosted Trees
if(!require("BART")) install.packages("BART")
if(!require("reticulate")) install.packages("reticulate") # Use python objects in R
if(!require("ROCR")) install.packages("ROCR")
if(!require("keras")) install.packages("keras") # Install keras for deep learning
if(!require("magritter")) install.packages("magritter") 
if(!require("lubridate")) install.packages("lubridate")
if(!require("sjmisc")) install.packages("sjmisc") # overloading is_empty

library(sjmisc) # overloading is_empty
library(lubridate)
library(magrittr)
library(keras)
reticulate::use_condaenv(condaenv = "r-tensorflow")
library(ROCR)
library(reticulate)
library(BART)
library(gbm)
library(randomForest)
library(tree)
library(akima)
library(gam)
library(splines)
library(glmnet)
library(pls)
library(leaps)
library(formulaic)
library(class)
library(e1071)
library(HH)
library(MASS)
library(ISLR2)
library(tidyverse)
library(caTools)
library(caret)
library(boot)
```

```{r include=FALSE}
custom_darkblue = "#1A0875"
custom_lightblue = "#34ABEB"
custom_red = "#a60808"
```

```{r include=FALSE}
f_print <- function(string){
  cat(str_wrap(string = string, width = 80, indent = 0, exdent = 0, whitespace_only = TRUE))
}
```

```{r}
train_data <- read.csv('./train_loans2013_2015q1_minimalprocessing.csv')
test_data <- read.csv('./test_loans2013_2015q1_minimalprocessing.csv')
```

## Cleaning Training Data
```{r}
sum(is.na(train_data))
```
```{r}
dim(train_data)
```

```{r}
names(train_data)
```

```{r}
head(train_data)
```

```{r}
# Identifying All Character Values
train_data_chr <- character()
for (i in seq_along(names(train_data))){
  names_train_data <- names(train_data)
  if(is.character(train_data[[i]])){
    train_data_chr[[i]] <- names_train_data[i]
  }
}
train_data_chr <- train_data_chr[!is.na(train_data_chr)]
```

```{r}
train_data[train_data_chr]$int_rate <- str_replace(train_data[train_data_chr]$int_rate, "\\%", "")
train_data[train_data_chr]$int_rate <- str_replace(train_data[train_data_chr]$int_rate, "[ ]", "")
train_data[train_data_chr]$int_rate <- as.numeric(train_data[train_data_chr]$int_rate)
```

```{r}
train_data[train_data_chr]$term <- str_replace(train_data[train_data_chr]$term, "[ ]+(months)", "")
train_data[train_data_chr]$term <- str_replace(train_data[train_data_chr]$term, "[ ]", "")
train_data[train_data_chr]$term <- as.numeric(train_data[train_data_chr]$term)
```

```{r}
train_data[train_data_chr]$grade <- as.factor(train_data[train_data_chr]$grade)
```

```{r}
train_data[train_data_chr]$sub_grade <- as.factor(train_data[train_data_chr]$sub_grade)
```

```{r}
# train_data[train_data_chr]$emp_length <- str_replace(train_data[train_data_chr]$emp_length, "[ ](years)", "")
train_data[train_data_chr]$emp_length <- as.factor(train_data[train_data_chr]$emp_length)
```

```{r}
train_data[train_data_chr]$home_ownership <- as.factor(train_data[train_data_chr]$home_ownership)
```

```{r}
train_data[train_data_chr]$verification_status <- as.factor(train_data[train_data_chr]$verification_status)
```

```{r}
train_data[train_data_chr]$purpose <- as.factor(train_data[train_data_chr]$purpose)
```

```{r}
train_data[train_data_chr]$title <- as.factor(train_data[train_data_chr]$title)
```

```{r}
train_data[train_data_chr]$addr_state <- as.factor(train_data[train_data_chr]$addr_state)
```

```{r}
train_data[train_data_chr]$earliest_cr_line <- as.factor(train_data[train_data_chr]$earliest_cr_line)
```

```{r}
train_data[train_data_chr]$revol_util <- str_replace(train_data[train_data_chr]$revol_util, "\\%", "")
```

```{r}
train_data[train_data_chr]$revol_util <- as.numeric(train_data[train_data_chr]$revol_util)
```

```{r}
train_data[train_data_chr]$initial_list_status <- as.factor(train_data[train_data_chr]$initial_list_status)
```

```{r}
train_data[train_data_chr]$last_pymnt_d <- as.factor(train_data[train_data_chr]$last_pymnt_d)
```

```{r}
# Checking for non-empty strings
j <- 0
for (i in length(train_data[train_data_chr]$next_pymnt_d)){
  if (!(is_empty(train_data[train_data_chr]$next_pymnt_d[[i]]))){
    j <- 1
    print(train_data[train_data_chr]$next_pymnt_d[[i]])
    break
  }
}
```

```{r}
train_data[train_data_chr]$last_credit_pull_d <- as.factor(train_data[train_data_chr]$last_credit_pull_d)
```

```{r}
# There are no unique values
# unique(as.factor(train_data[train_data_chr]$application_type))
```

```{r}
# There are no unique values
# unique(as.factor(train_data[train_data_chr]$hardship_flag))
```

```{r}
# There are no unique values
# unique(as.factor(train_data[train_data_chr]$disbursement_method))
```

```{r}
train_data[train_data_chr]$debt_settlement_flag <- as.factor(train_data[train_data_chr]$debt_settlement_flag)
```

```{r}
train_data[train_data_chr]$loan_status <- as.factor(train_data[train_data_chr]$loan_status)
```

```{r}
train_data[train_data_chr]$debt_settlement_flag_date <- as.factor(train_data[train_data_chr]$debt_settlement_flag_date)
```

```{r}
train_data[train_data_chr]$settlement_status <- as.factor(train_data[train_data_chr]$settlement_status)
```

```{r}
train_data[train_data_chr]$settlement_date <- as.factor(train_data[train_data_chr]$settlement_date)
```

```{r}
# Removing variables with no values, single values, mostly missing values, or no pertinent content
train_data %<>% select(everything(), -member_id, -id, -emp_title, -pymnt_plan, -url, -desc, -zip_code, -next_pymnt_d, -application_type, -hardship_flag, -hardship_type, -hardship_reason, -hardship_status, -hardship_start_date, -hardship_end_date, -payment_plan_start_date, -hardship_loan_status, -disbursement_method, -mths_since_rcnt_il, -settlement_amount, -settlement_percentage, -settlement_term, -revol_bal_joint, -mths_since_last_delinq, -mths_since_last_record, -mths_since_last_major_derog, -annual_inc_joint, -dti_joint, -open_acc_6m, -open_act_il, -open_il_12m, -open_il_24m, -total_bal_il, -il_util, -open_rv_12m, -open_rv_24m, -max_bal_bc, -all_util, -inq_fi, -total_cu_tl, -inq_last_12m, -mths_since_recent_bc_dlq, -mths_since_recent_revol_delinq, -sec_app_fico_range_low, -sec_app_fico_range_high, -sec_app_earliest_cr_line, -sec_app_inq_last_6mths, -sec_app_mort_acc, -sec_app_open_acc)
```

```{r}
train_data %<>% select(everything(), -verification_status_joint, -sec_app_revol_util, -sec_app_open_act_il, -sec_app_num_rev_accts, -sec_app_chargeoff_within_12_mths, -sec_app_collections_12_mths_ex_med, -sec_app_mths_since_last_major_derog, -deferral_term, -hardship_amount, -hardship_length, -hardship_last_payment_amount, -hardship_payoff_balance_amount, -orig_projected_additional_accrued_interest, -hardship_dpd)
```

```{r}
train_data %<>% select(everything(), -debt_settlement_flag_date, -settlement_status, -settlement_date)
```

```{r}
train_data <- drop_na(train_data)
```

```{r}
# loan_status & good_loan are not present in the test dataset
train_data %<>% select(everything(), -loan_status, -good_loan)
```


```{r}
train_data$issue_d <- as.factor(train_data$issue_d)
```


```{r}
# All data is present & transformed into either numeric or factors
train_data
```

## Cleaning Test Data
```{r}
test_data
```

```{r}
test_data_chr <- character()
for (i in seq_along(names(test_data))){
  names_train_data <- names(test_data)
  if(is.character(test_data[[i]])){
    test_data_chr[[i]] <- names_train_data[i]
  }
}
test_data_chr <- test_data_chr[!is.na(test_data_chr)]

```



```{r}
test_data[test_data_chr]$int_rate <- str_replace(test_data[test_data_chr]$int_rate, "\\%", "")
test_data[test_data_chr]$int_rate <- str_replace(test_data[test_data_chr]$int_rate, "[ ]", "")
test_data[test_data_chr]$int_rate <- as.numeric(test_data[test_data_chr]$int_rate)
```

```{r}
# test_data[test_data_chr]
```

```{r}
test_data[test_data_chr]$grade <- as.factor(test_data[test_data_chr]$grade)
```

```{r}
test_data[test_data_chr]$sub_grade <- as.factor(test_data[test_data_chr]$sub_grade)
```

```{r}
# test_data[test_data_chr]$emp_length <- str_replace(test_data[test_data_chr]$emp_length, "[ ](years)", "")
test_data[test_data_chr]$emp_length <- as.factor(test_data[test_data_chr]$emp_length)
```

```{r}
test_data[test_data_chr]$home_ownership <- as.factor(test_data[test_data_chr]$home_ownership)
```

```{r}
test_data[test_data_chr]$verification_status <- as.factor(test_data[test_data_chr]$verification_status)
```

```{r}
test_data[test_data_chr]$purpose <- as.factor(test_data[test_data_chr]$purpose)
```

```{r}
test_data[test_data_chr]$title <- as.factor(test_data[test_data_chr]$title)
```

```{r}
test_data[test_data_chr]$addr_state <- as.factor(test_data[test_data_chr]$addr_state)
```

```{r}
test_data[test_data_chr]$earliest_cr_line <- as.factor(test_data[test_data_chr]$earliest_cr_line)
```

```{r}
test_data[test_data_chr]$revol_util <- str_replace(test_data[test_data_chr]$revol_util, "\\%", "")
```

```{r}
test_data[test_data_chr]$revol_util <- as.numeric(test_data[test_data_chr]$revol_util)
```

```{r}
test_data[test_data_chr]$initial_list_status <- as.factor(test_data[test_data_chr]$initial_list_status)
```


```{r}
# Checking for non-empty strings
j <- 0
for (i in length(test_data[test_data_chr]$next_pymnt_d)){
  if (!(is_empty(test_data[test_data_chr]$next_pymnt_d[[i]]))){
    j <- 1
    print(test_data[test_data_chr]$next_pymnt_d[[i]])
    break
  }
}
```

```{r}
# There are no unique values
# unique(as.factor(test_data[test_data_chr]$application_type))
```

```{r}
# There are no unique values
# unique(as.factor(test_data[test_data_chr]$hardship_flag))
```

```{r}
# There are no unique values
# unique(as.factor(test_data[test_data_chr]$disbursement_method))
```

```{r}
test_data[test_data_chr]$debt_settlement_flag <- as.factor(test_data[test_data_chr]$debt_settlement_flag)
```

```{r}
test_data[test_data_chr]$debt_settlement_flag_date <- as.factor(test_data[test_data_chr]$debt_settlement_flag_date)
```

```{r}
test_data[test_data_chr]$settlement_status <- as.factor(test_data[test_data_chr]$settlement_status)
```

```{r}
test_data[test_data_chr]$settlement_date <- as.factor(test_data[test_data_chr]$settlement_date)
```

```{r}
# Removing variables with no values, single values, mostly missing values, or no pertinent content
test_data %<>% select(everything(), -member_id, -id, -emp_title, -pymnt_plan, -url, -desc, -zip_code, -next_pymnt_d, -application_type, -hardship_flag, -hardship_type, -hardship_reason, -hardship_status, -hardship_start_date, -hardship_end_date, -payment_plan_start_date, -hardship_loan_status, -disbursement_method, -mths_since_rcnt_il, -settlement_amount, -settlement_percentage, -settlement_term, -revol_bal_joint, -mths_since_last_delinq, -mths_since_last_record, -mths_since_last_major_derog, -annual_inc_joint, -dti_joint, -open_acc_6m, -open_act_il, -open_il_12m, -open_il_24m, -total_bal_il, -il_util, -open_rv_12m, -open_rv_24m, -max_bal_bc, -all_util, -inq_fi, -total_cu_tl, -inq_last_12m, -mths_since_recent_bc_dlq, -mths_since_recent_revol_delinq, -sec_app_fico_range_low, -sec_app_fico_range_high, -sec_app_earliest_cr_line, -sec_app_inq_last_6mths, -sec_app_mort_acc, -sec_app_open_acc)
```

```{r}
test_data %<>% select(everything(), -verification_status_joint, -sec_app_revol_util, -sec_app_open_act_il, -sec_app_num_rev_accts, -sec_app_chargeoff_within_12_mths, -sec_app_collections_12_mths_ex_med, -sec_app_mths_since_last_major_derog, -deferral_term, -hardship_amount, -hardship_length, -hardship_last_payment_amount, -hardship_payoff_balance_amount, -orig_projected_additional_accrued_interest, -hardship_dpd)
```

```{r}
test_data %<>% select(everything(), -debt_settlement_flag_date, -settlement_status, -settlement_date)
```

```{r}
near(length(names(test_data)), length(names(train_data)))
```

```{r}
names(test_data)
```

```{r}
names(train_data)
```

```{r}
# test_data <- drop_na(test_data)
```


```{r}
# test_data$funded_amnt <- as.numeric(test_data$funded_amnt)
# test_data$funded_amnt_inv <- as.numeric(test_data$funded_amnt_inv)
# test_data$term <- as.numeric(test_data$term)
# test_data$installment <- as.numeric(test_data$installment)
test_data$issue_d <- as.factor(test_data$issue_d)
# test_data$out_prncp <- as.numeric(test_data$out_prncp)
# test_data$out_prncp_inv <- as.numeric(test_data$out_prncp_inv)
# test_data$total_pymnt <- as.numeric(test_data$total_pymnt)
test_data %<>% mutate_if(is.logical, as.numeric)
```

```{r}
# All data is present & transformed into either numeric or factors
test_data
```

```{r}
train_data
```






